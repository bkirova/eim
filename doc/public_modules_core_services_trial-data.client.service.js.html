<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: public/modules/core/services/trial-data.client.service.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: public/modules/core/services/trial-data.client.service.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict';

/**
 * The `TrialData` service is responsible for collecting the responses
 * provided by the user over the course of an experiment session.
 *
 * @class Angular.TrialData
 * @memberof Angular
 */

angular.module('core').factory('TrialData', ['$log',
    function($log) {

        $log.info('Instantiating TrialData service.');

        /**
         * This function returns the object that will be populated with data
         * as responses are provided by the user. You are free to manipulate
         * this object to suit your needs, but take note of the properties
         * that are configured with the demo app that are described here. In
         * particular, take care when modifying the metadata and state
         * properties.
         *
         * @function BlankDataObject
         * @inner
         * @property {{}} answers This object is where the actual
         * responses from users are stored. For example, when you create a
         * question in your study specification document (see the
         * [README](index.html)) with its `questionStoragePath` property set
         * to `data.answers.foo`, it will appear in this object under
         * `answers.foo`.
         * @property {Date} date The date and time that this session commenced
         * @property {Object[]} media The media that were played during this
         * session
         * @property {*} timestamps Timestamps for different points during
         * the session
         * @property {{}} metadata Various important metadata (location,
         * language, terminal number, session number, etc.)
         * @property {{}} state Important data for maintaining the state of
         * the session
         * @memberof Angular.TrialData~
         * @returns {{}}
         */
        function BlankDataObject() {

            $log.debug('Creating new BlankDataObject.');

            return {
                answers: {},
                date: null,
                media: [],
                timestamps: {
                    start: null,
                    test: null,
                    media: [],
                    end: null
                },
                metadata: {
                    language: 'en',
                    session_number: null,
                    location: 'taipei_city',
                    terminal: null
                },
                state: {
                    currentSlideIndex: -1,
                    mediaPlayCount: 0
                }
            };
        }

        var trialData = {

            /**
             * The data object for this session. Originally set to a new
             * instance of a {@link
             * Angular.TrialData~BlankDataObject|BlankDataObject}.
             *
             * @name data
             * @memberof Angular.TrialData#
             */
            data: null,

            /**
             * Converts the object in {@link Angular.TrialData#data|data}
             * to JSON and returns it.
             *
             * @function toJson
             * @memberof Angular.TrialData#
             * @returns {string}
             */
            toJson: function() {
                $log.debug('TrialData service returning data as JSON.');
                return angular.toJson(this.data, true);
            },

            /**
             * Sets {@link Angular.TrialData#data|data} to a new
             * instance of a {@link
             * Angular.TrialData~BlankDataObject|BlankDataObject}.
             *
             * @function reset
             * @memberof Angular.TrialData#
             * @return {undefined}
             */
            reset: function() {
                $log.info('Resetting TrialData service.');
                this.data = new BlankDataObject();
            },

            /**
             * Sets the value for a 'keypath' in {@link
             * Angular.TrialData#data|data}. Keypaths are dot-delimited
             * 'addresses' into the {@link Angular.TrialData#data|data}
             * object. For instance, the string `'foo.bar.baz'` interpreted
             * as a keypath points to the `baz` property of an object, which
             * is the value of the `bar` property on the `foo` object:
             *
             * ```
             * data = {
             *     foo: {
             *         bar: {
             *             baz: 13 // foo.bar.baz points to this value
             *         }
             *     }
             * }
             * ```
             *
             * @function setValueForPath
             * @memberof Angular.TrialData#
             * @param {string} path The keypath (address) into {@link
             * Angular.TrialData#data|data}
             * @param {*} value The value that this keypath should hold
             * @param {*} options Currently only one option is supported:
             * `array_index`. If you pass `{array_index: 2}` with a keypath
             * of `foo`, this method will expect to find an *`Array`* at the
             * keypath `foo`, and will set the value at index 2 of this
             * array to `value`.
             * @return {undefined}
             */
            setValueForPath: function(path, value, options) {

                $log.debug('Setting ' + path + ' in TrialData to: ' +
                    value, options);

                if (value === 'true') {
                    value = true;
                } else if (value === 'false') {
                    value = false;
                }

                var numericRegex = /\d+\.?\d?/;
                if (typeof value === 'string' &amp;&amp; value.match(numericRegex)) {
                    value = parseFloat(value);
                }

                // Downcase simple strings
                if (typeof value === 'string') {
                    value = value.toLowerCase();
                }

                if (path &amp;&amp; value !== undefined) {
                    // A moving reference to internal objects within this
                    // (this TrialData)
                    var schema = this;
                    var pList = path.split('.');
                    var len = pList.length;
                    for (var i = 0; i &lt; len - 1; i++) {
                        var elem = pList[i];
                        if (!schema[elem]) schema[elem] = {};
                        schema = schema[elem];
                    }

                    if (options &amp;&amp; options.hasOwnProperty('array_index') &amp;&amp;
                        typeof options.array_index === 'number') {

                        if (schema[pList[len - 1]] === undefined) {
                            schema[pList[len - 1]] = [];
                        }

                        // Iterate over array up to one less than
                        // options.array_index. If each index isn't set up to
                        // this point, set it to null.
                        for (var j = 0; j &lt; options.array_index; j++) {
                            if (schema[pList[len - 1]][j] === undefined) {
                                schema[pList[len - 1]][j] = null;
                            }
                        }

                        schema[pList[len - 1]][options.array_index] = value;
                    } else {
                        schema[pList[len - 1]] = value;
                    }
                }
            },

            /**
             * Sets the value for a 'keypath' in {@link
             * Angular.TrialData#data|data}. (See {@link
             * Angular.TrialData~setValueForPath|setValueForPath} for more
             * infomation on 'paths'.)
             *
             * When this method is used, the current media in the experiment
             * session is observed. `value` is expected to be placed into an
             * `Array` that is stored at the keypath, and the number of the
             * current media is used to decide the index of this array at
             * which `value` should be stored. For instance, if the second
             * media excerpt was just played and this method was called with
             * `'data.answers.foo'` for `path` and `14` for `'value'`, `14`
             * would be stored in the second index of the array at
             * `'data.answers.foo'`.
             *
             * @function setValueForPathForCurrentmedia
             * @memberof Angular.TrialData#
             * @param {string} path The keypath (address) into {@link
                * Angular.TrialData#data|data}
             * @param {*} value The value that this keypath should hold
             * @return {undefined}
             */
            setValueForPathForCurrentMedia: function(path, value) {

                $log.debug('Setting ' + path + ' in TrialData for current' +
                    ' media to: ' + value + '.');

                var index;

                // If no media have played (we're likely debugging)
                if (this.data.state.mediaPlayCount &lt;= 0) {
                    index = 0;
                } else {
                    index = this.data.state.mediaPlayCount - 1;
                }

                this.setValueForPath(path, value, {array_index: index});
            },

            /**
             * Updates the language stored at the `metadata.language`
             * property of {@link Angular.TrialData#data|data}
             *
             * @function language
             * @memberof Angular.TrialData#
             * @param {string} newLanguage The language
             * @returns {string} The language to which the
             * `metadata.language` property of {@link
             * Angular.TrialData#data|data} is set after the call to this
             * method.
             */
            language: function(newLanguage) {

                if (typeof newLanguage === 'string') {

                    $log.info('Setting language in TrialData to ' +
                        newLanguage);

                    this.data.metadata.language = newLanguage;
                } else {
                    $log.error('Not updating language in TrialData. A string' +
                        ' was not received.');
                }

                return this.data.metadata.language;
            }
        };

        trialData.data = new BlankDataObject();

        return trialData;
    }
]);</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="Node.module_CoreServerRoutes.html">CoreServerRoutes</a></li><li><a href="Node.module_CustomConfiguration.html">CustomConfiguration</a></li><li><a href="Node.module_ExperimentSchemaServerController.html">ExperimentSchemaServerController</a></li><li><a href="Node.module_ExperimentSchemaServerModel.html">ExperimentSchemaServerModel</a></li><li><a href="Node.module_ExperimentSchemaServerRoutes.html">ExperimentSchemaServerRoutes</a></li><li><a href="Node.module_MediaServerModel.html">MediaServerModel</a></li><li><a href="Node.module_OSCServerController.html">OSCServerController</a></li><li><a href="Node.module_OSCServerRoutes.html">OSCServerRoutes</a></li><li><a href="Node.module_SocketServerController.html">SocketServerController</a></li><li><a href="Node.module_TrialServerController.html">TrialServerController</a></li><li><a href="Node.module_TrialServerRoutes.html">TrialServerRoutes</a></li></ul><h3>Classes</h3><ul><li><a href="Angular.checkboxQuestionDirective.html">checkboxQuestionDirective</a></li><li><a href="Angular.DemographicsController.html">DemographicsController</a></li><li><a href="Angular.displayTrialDataDirective.html">displayTrialDataDirective</a></li><li><a href="Angular.dropdownQuestionDirective.html">dropdownQuestionDirective</a></li><li><a href="Angular.EmotionIndexController.html">EmotionIndexController</a></li><li><a href="Angular.ExperimentManager.html">ExperimentManager</a></li><li><a href="Angular.HomeController.html">HomeController</a></li><li><a href="Angular.LastScreenController.html">LastScreenController</a></li><li><a href="Angular.MasterController.html">MasterController</a></li><li><a href="Angular.MediaPlaybackController.html">MediaPlaybackController</a></li><li><a href="Angular.MissingKeys.html">MissingKeys</a></li><li><a href="Angular.OSC.html">OSC</a></li><li><a href="Angular.QuestionnaireController.html">QuestionnaireController</a></li><li><a href="Angular.questionnaireDirective.html">questionnaireDirective</a></li><li><a href="Angular.radioQuestionDirective.html">radioQuestionDirective</a></li><li><a href="Angular.Routes.html">Routes</a></li><li><a href="Angular.scaleQuestionDirective.html">scaleQuestionDirective</a></li><li><a href="Angular.SignalTestController.html">SignalTestController</a></li><li><a href="Angular.SoundTestController.html">SoundTestController</a></li><li><a href="Angular.StartController.html">StartController</a></li><li><a href="Angular.TrialData.html">TrialData</a></li></ul><h3>Events</h3><ul><li><a href="Node.module_OSCServerController.html#~event:oscMessageReceived">oscMessageReceived</a></li><li><a href="Node.module_SocketServerController.html#~event:oscMessageSent">oscMessageSent</a></li></ul><h3>Namespaces</h3><ul><li><a href="Angular.html">Angular</a></li><li><a href="Angular.DemographicsController_$scope.html">$scope</a></li><li><a href="Angular.EmotionIndexController_$scope.html">$scope</a></li><li><a href="Angular.HomeController_$scope.html">$scope</a></li><li><a href="Angular.MasterController_$scope.html">$scope</a></li><li><a href="Angular.MediaPlaybackController_$scope.html">$scope</a></li><li><a href="Angular.QuestionnaireController_$scope.html">$scope</a></li><li><a href="Angular.questionnaireDirective_data.html">data</a></li><li><a href="Angular.SignalTestController_$scope.html">$scope</a></li><li><a href="Angular.SoundTestController_$scope.html">$scope</a></li><li><a href="Angular.StartController_$scope.html">$scope</a></li><li><a href="Node.html">Node</a></li><li><a href="Node.module_CustomConfiguration-customConfiguration.html">customConfiguration</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.3</a> on Fri Oct 09 2015 12:46:52 GMT-0400 (EDT)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
